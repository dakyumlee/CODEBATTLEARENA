<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 문제 풀이 - 코드배틀아레나</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/student.css">
    <style>
        .problem-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 200px);
            margin-top: 2rem;
        }
        .problem-content {
            background: #1e293b;
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 0.75rem;
            overflow-y: auto;
        }
        .code-editor {
            background: #0f172a;
            padding: 2rem;
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        #codeTextarea {
            flex: 1;
            min-height: 400px;
            background: #0f172a;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
        }
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .result-panel {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: #1e293b;
            color: #e2e8f0;
            display: none;
        }
    </style>
<link rel="stylesheet" href="/css/mobile.css">
<script src="/js/mobile.js">
</head>
<body>
    <div class="header">
        <div class="nav">
            <a href="/" class="logo">코드배틀아레나</a>
            <ul class="nav-links">
                <li><a href="/student">대시보드</a></li>
                <li><a href="/student/today">오늘의 학습</a></li>
                <li><a href="#" onclick="logout()">로그아웃</a></li>
            </ul>
        </div>
    </div>

    <div class="student-dashboard">
        <div class="student-header">
            <h1 class="student-title">AI 추천 문제</h1>
            <p class="student-subtitle">AI가 당신의 수준에 맞는 문제를 추천했습니다</p>
        </div>

        <div class="problem-container">
            <div class="problem-content">
                <h2 id="problemTitle">문제를 불러오는 중...</h2>
                <div id="problemMeta" style="margin: 1rem 0; color: #94a3b8;"></div>
                
                <h3>문제 설명</h3>
                <div id="problemDescription" style="margin-bottom: 2rem; line-height: 1.6; background: #334155; padding: 1.5rem; border-radius: 0.5rem;">
                    문제 설명을 불러오는 중...
                </div>

                <h3>입출력 예제</h3>
                <div id="problemExample" style="background: #334155; padding: 1.5rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-line;">
                    예제를 불러오는 중...
                </div>

                <h3>제약 조건</h3>
                <div id="problemConstraints" style="background: #334155; padding: 1.5rem; border-radius: 0.5rem;">
                    제약 조건을 확인하는 중...
                </div>
            </div>

            <div class="code-editor">
                <h3 style="color: #e2e8f0; margin-bottom: 1rem;">코드 작성</h3>
                <textarea id="codeTextarea" placeholder="여기에 코드를 작성하세요...

public class Solution {
    public static void main(String[] args) {
        // 여기에 코드를 작성하세요
        
    }
}"></textarea>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="testCode()">테스트 실행</button>
                    <button class="btn" onclick="submitSolution()">제출하기</button>
                    <button class="btn" style="background: #6b7280;" onclick="goBack()">뒤로가기</button>
                </div>

                <div id="resultPanel" class="result-panel">
                    <h4>실행 결과</h4>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/common/auth.js"></script>
    <script>
        const aiProblems = [
            {
                id: "ai_001",
                title: "두 수의 합 구하기",
                difficulty: "하",
                points: 10,
                description: "두 정수 A와 B를 입력받아 A+B를 출력하는 프로그램을 작성하시오.\n\n이 문제는 가장 기본적인 입출력 문제입니다. 프로그래밍 언어의 기본 문법을 익히는 데 도움이 됩니다.",
                example: "입력:\n1 2\n\n출력:\n3\n\n입력:\n5 7\n\n출력:\n12",
                constraints: "• -1000 ≤ A, B ≤ 1000\n• 입력은 한 줄에 두 정수가 공백으로 구분되어 주어집니다\n• 출력은 한 줄에 결과값 하나만 출력합니다",
                testCases: [
                    { input: "1 2", expectedOutput: "3" },
                    { input: "5 7", expectedOutput: "12" },
                    { input: "-1 3", expectedOutput: "2" }
                ]
            },
            {
                id: "ai_002", 
                title: "배열에서 최댓값 찾기",
                difficulty: "중",
                points: 20,
                description: "N개의 정수가 주어졌을 때, 이 중에서 가장 큰 값을 찾아 출력하는 프로그램을 작성하시오.\n\n배열을 사용하여 여러 개의 값을 처리하는 방법을 학습할 수 있습니다.",
                example: "입력:\n5\n3 7 2 9 1\n\n출력:\n9\n\n입력:\n4\n-1 -5 -3 -2\n\n출력:\n-1",
                constraints: "• 1 ≤ N ≤ 100\n• -1000 ≤ 각 원소 ≤ 1000\n• 첫 번째 줄에 N이 주어집니다\n• 두 번째 줄에 N개의 정수가 공백으로 구분되어 주어집니다",
                testCases: [
                    { input: "5\n3 7 2 9 1", expectedOutput: "9" },
                    { input: "4\n-1 -5 -3 -2", expectedOutput: "-1" },
                    { input: "3\n10 10 10", expectedOutput: "10" }
                ]
            }
        ];

        let currentProblem = null;

        function loadRandomProblem() {
            const randomIndex = Math.floor(Math.random() * aiProblems.length);
            currentProblem = aiProblems[randomIndex];
            
            document.getElementById('problemTitle').textContent = currentProblem.title;
            document.getElementById('problemMeta').innerHTML = `
                <span style="background: ${getDifficultyColor(currentProblem.difficulty)}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; margin-right: 0.5rem;">${currentProblem.difficulty}</span>
                <span>${currentProblem.points}점</span>
            `;
            document.getElementById('problemDescription').textContent = currentProblem.description;
            document.getElementById('problemExample').textContent = currentProblem.example;
            document.getElementById('problemConstraints').textContent = currentProblem.constraints;
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case '하': return '#10b981';
                case '중': return '#f59e0b'; 
                case '상': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function testCode() {
            const code = document.getElementById('codeTextarea').value.trim();
            const resultPanel = document.getElementById('resultPanel');
            const resultContent = document.getElementById('resultContent');
            
            if (!code) {
                resultContent.innerHTML = '<div style="color: #ef4444;">코드를 입력해주세요.</div>';
                resultPanel.style.display = 'block';
                return;
            }

            resultContent.innerHTML = '<div style="color: #3b82f6;">테스트 실행 중...</div>';
            resultPanel.style.display = 'block';
            
            setTimeout(() => {
                const results = runTestCases(code);
                displayTestResults(results);
            }, 1500);
        }

        function runTestCases(code) {
            if (!currentProblem || !currentProblem.testCases) {
                return { success: false, message: "테스트 케이스가 없습니다." };
            }

            // 간단한 코드 검증
            if (code.length < 30) {
                return { success: false, message: "코드가 너무 짧습니다. 더 자세히 작성해주세요." };
            }

            if (!code.includes('System.out.print') && !code.includes('print') && !code.includes('cout')) {
                return { success: false, message: "출력문이 없습니다. System.out.println() 등을 사용해주세요." };
            }

            // AI 기반 정답 판정 시뮬레이션
            const passedTests = [];
            const failedTests = [];

            currentProblem.testCases.forEach((testCase, index) => {
                const isCorrect = checkSolution(code, testCase, currentProblem.id);
                
                if (isCorrect) {
                    passedTests.push({ index: index + 1, input: testCase.input, expected: testCase.expectedOutput });
                } else {
                    failedTests.push({ index: index + 1, input: testCase.input, expected: testCase.expectedOutput, actual: "오답" });
                }
            });

            return {
                success: failedTests.length === 0,
                passedTests,
                failedTests,
                totalTests: currentProblem.testCases.length
            };
        }

        function checkSolution(code, testCase, problemId) {
            // AI 기반 정답 판정 로직 시뮬레이션
            if (problemId === "ai_001") {
                // 두 수의 합: 덧셈 연산이 있는지 확인
                return code.includes('+') || code.includes('add') || code.includes('sum');
            } else if (problemId === "ai_002") {
                // 최댓값: Math.max나 비교 연산이 있는지 확인
                return code.includes('Math.max') || (code.includes('for') && code.includes('>')) || code.includes('max');
            }
            
            // 기본적으로 70% 확률로 정답
            return Math.random() > 0.3;
        }

        function displayTestResults(results) {
            const resultContent = document.getElementById('resultContent');
            
            if (results.success) {
                resultContent.innerHTML = `
                    <div style="color: #10b981; margin-bottom: 1rem;">
                        <strong>✅ 모든 테스트 케이스 통과! (${results.passedTests.length}/${results.totalTests})</strong>
                    </div>
                    ${results.passedTests.map(test => `
                        <div style="background: #065f46; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                            <strong>테스트 ${test.index}:</strong> 통과<br>
                            <small>입력: ${test.input.replace(/\n/g, ' ')} → 출력: ${test.expected}</small>
                        </div>
                    `).join('')}
                    <div style="margin-top: 1rem; color: #10b981;">
                        <strong>제출하시겠습니까?</strong>
                    </div>
                `;
            } else {
                resultContent.innerHTML = `
                    <div style="color: #ef4444; margin-bottom: 1rem;">
                        <strong>❌ ${results.failedTests ? results.failedTests.length : 0}개 테스트 실패 (${results.passedTests ? results.passedTests.length : 0}/${results.totalTests} 통과)</strong>
                    </div>
                    ${results.message ? `<div style="color: #f59e0b; margin-bottom: 1rem;">${results.message}</div>` : ''}
                    ${results.failedTests ? results.failedTests.map(test => `
                        <div style="background: #7f1d1d; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                            <strong>테스트 ${test.index}:</strong> 실패<br>
                            <small>입력: ${test.input.replace(/\n/g, ' ')}<br>기댓값: ${test.expected}<br>실제값: ${test.actual}</small>
                        </div>
                    `).join('') : ''}
                    ${results.passedTests ? results.passedTests.map(test => `
                        <div style="background: #065f46; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;">
                            <strong>테스트 ${test.index}:</strong> 통과<br>
                            <small>입력: ${test.input.replace(/\n/g, ' ')} → 출력: ${test.expected}</small>
                        </div>
                    `).join('') : ''}
                `;
            }
        }

        function submitSolution() {
            const code = document.getElementById('codeTextarea').value.trim();
            
            if (!code) {
                alert('코드를 입력해주세요.');
                return;
            }

            const results = runTestCases(code);
            const score = Math.round((results.passedTests.length / results.totalTests) * 100);
            
            if (results.success) {
                alert(`🎉 정답입니다!\n\n점수: ${currentProblem.points}점\n정확도: 100%\n\n다음 문제를 도전해보세요!`);
            } else {
                alert(`제출 완료!\n\n점수: ${Math.round(score * currentProblem.points / 100)}점\n정확도: ${score}%\n\n통과한 테스트: ${results.passedTests.length}/${results.totalTests}개`);
            }
            
            setTimeout(() => {
                if (confirm('다른 AI 문제를 풀어보시겠습니까?')) {
                    loadRandomProblem();
                    document.getElementById('codeTextarea').value = '';
                    document.getElementById('resultPanel').style.display = 'none';
                } else {
                    goBack();
                }
            }, 1000);
        }

        function goBack() {
            window.location.href = '/student/today';
        }

        function logout() {
            AuthManager.logout();
        }

        // 페이지 로드 시 랜덤 문제 로드
        loadRandomProblem();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/common/websocket.js"></script>
    <script src="/js/common/student-activity.js"></script>
</body>
</html>
