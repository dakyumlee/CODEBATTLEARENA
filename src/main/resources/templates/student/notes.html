<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>복습노트 - 코드배틀아레나</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/student.css">
</head>
<body>
    <div class="header">
        <div class="nav">
            <a href="/" class="logo">코드배틀아레나</a>
            <ul class="nav-links">
                <li><a href="/student">대시보드</a></li>
                <li><a href="#" onclick="logout()">로그아웃</a></li>
            </ul>
        </div>
    </div>

    <div class="student-dashboard">
        <div class="student-header">
            <h1 class="student-title">복습노트</h1>
            <p class="student-subtitle">학습 내용을 정리하고 복습하세요</p>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3>나의 노트</h3>
                <button onclick="showCreateForm()" class="btn">새 노트 작성</button>
            </div>

            <div id="createForm" class="card" style="display: none; background: #334155; margin-bottom: 2rem;">
                <h4>새 노트 작성</h4>
                <div style="margin: 1rem 0;">
                    <input type="text" id="noteTitle" class="input" placeholder="노트 제목" style="margin-bottom: 1rem;">
                    <textarea id="noteContent" class="input" placeholder="학습 내용을 자유롭게 작성하세요..." style="min-height: 150px; margin-bottom: 1rem;"></textarea>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="saveNote()" class="btn">저장</button>
                        <button onclick="cancelNote()" class="btn" style="background: #6b7280;">취소</button>
                    </div>
                </div>
            </div>

            <div id="notesList">
                <div style="text-align: center; color: #64748b; padding: 2rem;">
                    노트를 불러오는 중...
                </div>
            </div>
        </div>
    </div>

    <script src="/js/common/auth.js"></script>
    <script>
        let editingNoteId = null;

        async function loadNotes() {
            try {
                const notes = await fetch('/api/student/notes', {
                    headers: AuthManager.getAuthHeaders()
                }).then(r => r.json());

                const notesList = document.getElementById('notesList');
                
                if (notes.length === 0) {
                    notesList.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">아직 작성한 노트가 없습니다.</div>';
                    return;
                }

                notesList.innerHTML = notes.map(note => `
                    <div class="note-item" style="background: #334155; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="color: #e2e8f0; margin-bottom: 0.5rem;">${note.title}</h4>
                                <p style="color: #cbd5e1; line-height: 1.6; white-space: pre-wrap;">${note.content}</p>
                                <div style="color: #64748b; font-size: 0.9rem; margin-top: 1rem;">
                                    ${new Date(note.createdAt).toLocaleDateString('ko-KR')}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                <button onclick="editNote(${note.id}, '${note.title}', '${note.content}')" class="btn btn-secondary" style="padding: 0.5rem;">수정</button>
                                <button onclick="deleteNote(${note.id})" class="btn btn-danger" style="padding: 0.5rem;">삭제</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('notesList').innerHTML = 
                    '<div style="text-align: center; color: #ef4444; padding: 2rem;">노트를 불러올 수 없습니다.</div>';
            }
        }

        function showCreateForm() {
            document.getElementById('createForm').style.display = 'block';
            document.getElementById('noteTitle').focus();
            editingNoteId = null;
        }

        function editNote(id, title, content) {
            editingNoteId = id;
            document.getElementById('noteTitle').value = title;
            document.getElementById('noteContent').value = content;
            document.getElementById('createForm').style.display = 'block';
            document.querySelector('#createForm h4').textContent = '노트 수정';
        }

        function cancelNote() {
            document.getElementById('createForm').style.display = 'none';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.querySelector('#createForm h4').textContent = '새 노트 작성';
            editingNoteId = null;
        }

        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                alert('제목과 내용을 모두 입력해주세요.');
                return;
            }

            try {
                const url = editingNoteId ? `/api/student/notes/${editingNoteId}` : '/api/student/notes';
                const method = editingNoteId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...AuthManager.getAuthHeaders()
                    },
                    body: JSON.stringify({ title, content })
                });

                if (response.ok) {
                    alert(editingNoteId ? '노트가 수정되었습니다.' : '노트가 저장되었습니다.');
                    cancelNote();
                    loadNotes(); // 노트 목록 새로고침
                } else {
                    throw new Error('저장 실패');
                }
            } catch (error) {
                alert('노트 저장에 실패했습니다: ' + error.message);
            }
        }

        async function deleteNote(id) {
            if (!confirm('정말 이 노트를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/student/notes/${id}`, {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    alert('노트가 삭제되었습니다.');
                    loadNotes();
                } else {
                    throw new Error('삭제 실패');
                }
            } catch (error) {
                alert('노트 삭제에 실패했습니다: ' + error.message);
            }
        }

        function logout() {
            AuthManager.logout();
        }

        loadNotes();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/common/websocket.js"></script>
    <script src="/js/common/student-activity.js"></script>
</body>
</html>
