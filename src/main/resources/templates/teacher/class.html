<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수업관리 - 코드배틀아레나</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/teacher.css">
</head>
<body class="teacher-page">
    <div class="header">
        <div class="nav">
            <a href="/" class="logo">코드배틀아레나</a>
            <ul class="nav-links">
                <li><a href="/teacher/dashboard">대시보드</a></li>
                <li><a href="/teacher/class">수업관리</a></li>
                <li><a href="/teacher/grades">성적관리</a></li>
                <li><a href="#" onclick="logout()">로그아웃</a></li>
            </ul>
        </div>
    </div>

    <div class="teacher-dashboard">
        <div class="teacher-header">
            <h1 class="teacher-title">수업관리</h1>
            <p class="teacher-subtitle">자료 공유, 문제 출제, 과제 관리</p>
        </div>

        <div class="card">
            <h3>자료 관리</h3>
            <div style="margin: 2rem 0;">
                <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" multiple accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.zip">
                <button class="btn" onclick="document.getElementById('fileInput').click()">파일 업로드</button>
                <button class="btn btn-secondary" onclick="shareLink()" style="margin-left: 1rem;">링크 공유</button>
            </div>
            
            <div id="materialsList">
                <div style="text-align: center; color: #64748b; padding: 2rem;">자료를 불러오는 중...</div>
            </div>
        </div>

        <div class="card">
            <h3>문제 출제</h3>
            <div style="display: flex; gap: 1rem; margin: 2rem 0;">
                <button class="btn" onclick="showProblemForm('quiz')">퀴즈 만들기</button>
                <button class="btn btn-secondary" onclick="showProblemForm('assignment')">과제 내기</button>
                <button class="btn" onclick="showProblemForm('exam')">시험 출제</button>
            </div>

            <div id="problemForm" style="display: none; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; margin: 2rem 0;">
                <h4 id="problemFormTitle">문제 출제</h4>
                <form onsubmit="submitProblem(event)">
                    <input type="hidden" id="problemType">
                    <input type="text" id="problemTitle" class="input" placeholder="문제 제목" style="margin-bottom: 1rem;" required>
                    <textarea id="problemDescription" class="input" placeholder="문제 설명" style="min-height: 150px; margin-bottom: 1rem;" required></textarea>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <select id="problemDifficulty" class="input" style="width: auto;">
                            <option value="하">하</option>
                            <option value="중">중</option>
                            <option value="상">상</option>
                        </select>
                        <input type="number" id="problemPoints" class="input" placeholder="점수" min="1" max="100" value="10" style="width: 100px;">
                        <input type="datetime-local" id="problemDeadline" class="input" style="width: auto;">
                    </div>
                    <div>
                        <button type="submit" class="btn">출제하기</button>
                        <button type="button" onclick="hideProblemForm()" class="btn" style="background: #6b7280; margin-left: 1rem;">취소</button>
                    </div>
                </form>
            </div>

            <div id="problemsList">
                <div style="text-align: center; color: #64748b; padding: 2rem;">출제한 문제를 불러오는 중...</div>
            </div>
        </div>

        <div class="card">
            <h3>제출된 답안</h3>
            <div id="submissionsList">
                <div style="text-align: center; color: #64748b; padding: 2rem;">제출된 답안을 불러오는 중...</div>
            </div>
        </div>
    </div>

    <script src="/js/common/auth.js"></script>
    <script src="/js/common/api.js"></script>
    <script>
        async function loadMaterials() {
            try {
                const materials = await ApiClient.get('/api/teacher/materials');
                displayMaterials(materials);
            } catch (error) {
                document.getElementById('materialsList').innerHTML = 
                    '<div style="text-align: center; color: #ef4444; padding: 2rem;">자료를 불러올 수 없습니다.</div>';
                console.error('자료 로드 실패:', error);
            }
        }

        function displayMaterials(materials) {
            const listDiv = document.getElementById('materialsList');
            
            if (materials.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">업로드된 자료가 없습니다.</div>';
                return;
            }

            listDiv.innerHTML = materials.map(material => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin: 0.5rem 0;">
                    <div>
                        <strong>${material.title}</strong>
                        <div style="color: #64748b; font-size: 0.9rem;">업로드: ${formatDate(material.createdAt)} | 다운로드: ${material.downloadsCount}회</div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="previewFile(${material.id})" style="padding: 0.5rem; margin-right: 0.5rem;">미리보기</button>
                        <button class="btn btn-danger" onclick="deleteMaterial(${material.id})" style="padding: 0.5rem;">삭제</button>
                    </div>
                </div>
            `).join('');
        }

        async function uploadFile() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) return;

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                await fetch('/api/teacher/materials/upload', {
                    method: 'POST',
                    headers: AuthManager.getAuthHeaders(),
                    body: formData
                });
                alert('파일이 업로드되었습니다.');
                loadMaterials();
            } catch (error) {
                alert('파일 업로드에 실패했습니다: ' + error.message);
            }
        }

        function shareLink() {
            const url = prompt('공유할 링크 URL을 입력하세요:');
            const title = prompt('링크 제목을 입력하세요:');
            
            if (url && title) {
                ApiClient.post('/api/teacher/materials/link', { url, title })
                    .then(() => {
                        alert('링크가 공유되었습니다.');
                        loadMaterials();
                    })
                    .catch(error => alert('링크 공유에 실패했습니다: ' + error.message));
            }
        }

        function showProblemForm(type) {
            document.getElementById('problemType').value = type;
            document.getElementById('problemFormTitle').textContent = 
                type === 'quiz' ? '퀴즈 만들기' : type === 'assignment' ? '과제 내기' : '시험 출제';
            document.getElementById('problemForm').style.display = 'block';
        }

        function hideProblemForm() {
            document.getElementById('problemForm').style.display = 'none';
            document.querySelector('#problemForm form').reset();
        }

        async function submitProblem(event) {
            event.preventDefault();
            
            const data = {
                type: document.getElementById('problemType').value,
                title: document.getElementById('problemTitle').value,
                description: document.getElementById('problemDescription').value,
                difficulty: document.getElementById('problemDifficulty').value,
                points: document.getElementById('problemPoints').value,
                deadline: document.getElementById('problemDeadline').value
            };

            try {
                await ApiClient.post('/api/teacher/problems', data);
                alert('문제가 출제되었습니다.');
                hideProblemForm();
                loadProblems();
            } catch (error) {
                alert('문제 출제에 실패했습니다: ' + error.message);
            }
        }

        async function loadProblems() {
            try {
                const problems = await ApiClient.get('/api/teacher/problems');
                displayProblems(problems);
            } catch (error) {
                document.getElementById('problemsList').innerHTML = 
                    '<div style="text-align: center; color: #ef4444; padding: 2rem;">문제를 불러올 수 없습니다.</div>';
                console.error('문제 로드 실패:', error);
            }
        }

        function displayProblems(problems) {
            const listDiv = document.getElementById('problemsList');
            
            if (problems.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">출제한 문제가 없습니다.</div>';
                return;
            }

            listDiv.innerHTML = problems.map(problem => `
                <div style="border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h4>${problem.title}</h4>
                            <p style="color: #64748b; margin: 0.5rem 0;">${problem.description.substring(0, 100)}...</p>
                            <span style="background: ${getDifficultyColor(problem.difficulty)}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem;">
                                ${problem.difficulty}
                            </span>
                            <span style="margin-left: 1rem; color: #3b82f6;">${problem.points}점</span>
                        </div>
                        <button class="btn" onclick="viewSubmissions(${problem.id})" style="padding: 0.5rem;">답안 보기</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadSubmissions() {
            try {
                const submissions = await ApiClient.get('/api/teacher/submissions');
                displaySubmissions(submissions);
            } catch (error) {
                document.getElementById('submissionsList').innerHTML = 
                    '<div style="text-align: center; color: #ef4444; padding: 2rem;">답안을 불러올 수 없습니다.</div>';
                console.error('답안 로드 실패:', error);
            }
        }

        function displaySubmissions(submissions) {
            const listDiv = document.getElementById('submissionsList');
            
            if (submissions.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">제출된 답안이 없습니다.</div>';
                return;
            }

            listDiv.innerHTML = submissions.map(submission => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin: 0.5rem 0;">
                    <div>
                        <strong>${submission.studentName}</strong> - ${submission.problemTitle}
                        <div style="color: #64748b; font-size: 0.9rem;">제출시간: ${formatDate(submission.submittedAt)}</div>
                    </div>
                    <div>
                        ${submission.score !== null ? 
                            `<span style="color: ${submission.score >= 80 ? '#10b981' : submission.score >= 60 ? '#f59e0b' : '#ef4444'}; margin-right: 1rem;">${submission.score}점</span>` : 
                            ''
                        }
                        <button class="btn" onclick="gradeSubmission(${submission.id})" style="padding: 0.5rem;">채점하기</button>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyColor(difficulty) {
            switch(difficulty) {
                case '하': return '#10b981';
                case '중': return '#f59e0b';
                case '상': return '#ef4444';
                default: return '#6b7280';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('ko-KR');
        }

        function previewFile(fileId) {
            window.open(`/api/files/preview/${fileId}`, '_blank');
        }

        function deleteMaterial(materialId) {
            if (confirm('정말로 이 자료를 삭제하시겠습니까?')) {
                ApiClient.delete(`/api/teacher/materials/${materialId}`)
                    .then(() => {
                        alert('자료가 삭제되었습니다.');
                        loadMaterials();
                    })
                    .catch(error => alert('자료 삭제에 실패했습니다: ' + error.message));
            }
        }

        function viewSubmissions(problemId) {
            location.href = `/teacher/problem/${problemId}/submissions`;
        }

        function gradeSubmission(submissionId) {
            location.href = `/teacher/submission/${submissionId}/grade`;
        }

        function logout() {
            AuthManager.logout();
        }

        loadMaterials();
        loadProblems();
        loadSubmissions();
    </script>
</body>
</html>
