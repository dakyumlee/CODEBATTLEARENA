<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성적관리 - 코드배틀아레나</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/teacher.css">
</head>
<body class="teacher-page">
    <div class="header">
        <div class="nav">
            <a href="/" class="logo">코드배틀아레나</a>
            <ul class="nav-links">
                <li><a href="/teacher/dashboard">대시보드</a></li>
                <li><a href="/teacher/class">수업관리</a></li>
                <li><a href="/teacher/grades">성적관리</a></li>
                <li><a href="#" onclick="logout()">로그아웃</a></li>
            </ul>
        </div>
    </div>

    <div class="teacher-dashboard">
        <div class="teacher-header">
            <h1 class="teacher-title">성적관리</h1>
            <p class="teacher-subtitle">학생별 성적 분석 및 통계</p>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3>성적 현황</h3>
                <div>
                    <select id="periodSelect" class="input" style="width: auto; margin-right: 1rem;">
                        <option value="all">전체 기간</option>
                        <option value="thisMonth">이번 달</option>
                        <option value="lastMonth">지난 달</option>
                        <option value="thisWeek">이번 주</option>
                    </select>
                    <button class="btn" onclick="exportCSV()">CSV 내보내기</button>
                    <button class="btn btn-secondary" onclick="exportPDF()" style="margin-left: 0.5rem;">PDF 내보내기</button>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 1rem; text-align: left;">학생명</th>
                            <th style="padding: 1rem; text-align: center;">출석률</th>
                            <th style="padding: 1rem; text-align: center;">퀴즈 평균</th>
                            <th style="padding: 1rem; text-align: center;">과제 평균</th>
                            <th style="padding: 1rem; text-align: center;">시험 점수</th>
                            <th style="padding: 1rem; text-align: center;">총점</th>
                            <th style="padding: 1rem; text-align: center;">등급</th>
                            <th style="padding: 1rem; text-align: center;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="gradesTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 2rem;">성적 데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>성적 분석</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin: 2rem 0;">
                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <div style="font-size: 2rem; font-weight: bold; color: #3b82f6;" id="classAverage">-</div>
                    <div style="color: #64748b;">반 평균</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="passRate">-</div>
                    <div style="color: #64748b;">합격률</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="improvementRate">-</div>
                    <div style="color: #64748b;">향상률</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <div style="font-size: 2rem; font-weight: bold; color: #ef4444;" id="attendanceRate">-</div>
                    <div style="color: #64748b;">평균 출석률</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>개별 학생 상담</h3>
            <div id="counselingList">
                <div style="text-align: center; color: #64748b; padding: 2rem;">상담이 필요한 학생을 분석 중...</div>
            </div>
        </div>
    </div>

    <script src="/js/common/auth.js"></script>
    <script src="/js/common/api.js"></script>
    <script>
        async function loadGrades() {
            try {
                const response = await ApiClient.get('/api/teacher/grades');
                displayGrades(response.grades);
                displayAnalysis(response.analysis);
                displayCounseling(response.counseling);
            } catch (error) {
                document.getElementById('gradesTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; color: #ef4444; padding: 2rem;">성적 데이터를 불러올 수 없습니다.</td></tr>';
                console.error('성적 로드 실패:', error);
            }
        }

        function displayGrades(grades) {
            const tbody = document.getElementById('gradesTableBody');
            
            if (grades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b; padding: 2rem;">등록된 학생이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = grades.map(grade => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 1rem; font-weight: 600;">${grade.studentName}</td>
                    <td style="padding: 1rem; text-align: center;">${grade.attendanceRate}%</td>
                    <td style="padding: 1rem; text-align: center;">${grade.quizAverage || '-'}</td>
                    <td style="padding: 1rem; text-align: center;">${grade.assignmentAverage || '-'}</td>
                    <td style="padding: 1rem; text-align: center;">${grade.examScore || '-'}</td>
                    <td style="padding: 1rem; text-align: center; font-weight: bold;">${grade.totalScore}</td>
                    <td style="padding: 1rem; text-align: center;">
                        <span style="background: ${getGradeColor(grade.grade)}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: bold;">
                            ${grade.grade}
                        </span>
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <button class="btn btn-secondary" onclick="openStudentDetail(${grade.studentId})" style="padding: 0.5rem;">상세보기</button>
                    </td>
                </tr>
            `).join('');
        }

        function displayAnalysis(analysis) {
            document.getElementById('classAverage').textContent = analysis.classAverage + '점';
            document.getElementById('passRate').textContent = analysis.passRate + '%';
            document.getElementById('improvementRate').textContent = analysis.improvementRate + '%';
            document.getElementById('attendanceRate').textContent = analysis.attendanceRate + '%';
        }

        function displayCounseling(counselingList) {
            const listDiv = document.getElementById('counselingList');
            
            if (counselingList.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #64748b; padding: 2rem;">특별한 관리가 필요한 학생이 없습니다.</div>';
                return;
            }

            listDiv.innerHTML = counselingList.map(student => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin: 0.5rem 0;">
                    <div>
                        <strong>${student.name}</strong>
                        <div style="color: #64748b; font-size: 0.9rem;">${student.reason}</div>
                    </div>
                    <div>
                        <span style="background: ${student.priority === '높음' ? '#ef4444' : student.priority === '중간' ? '#f59e0b' : '#10b981'}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; margin-right: 1rem;">
                            ${student.priority} 우선순위
                        </span>
                        <button class="btn" onclick="startCounseling(${student.id})" style="padding: 0.5rem;">상담하기</button>
                    </div>
                </div>
            `).join('');
        }

        function getGradeColor(grade) {
            switch(grade) {
                case 'A+': case 'A': return '#10b981';
                case 'B+': case 'B': return '#3b82f6';
                case 'C+': case 'C': return '#f59e0b';
                case 'D+': case 'D': return '#ef4444';
                case 'F': return '#991b1b';
                default: return '#6b7280';
            }
        }

        async function exportCSV() {
            try {
                const response = await fetch('/api/teacher/grades/export/csv', {
                    headers: AuthManager.getAuthHeaders()
                });
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `성적표_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('CSV 내보내기에 실패했습니다: ' + error.message);
            }
        }

        async function exportPDF() {
            try {
                const response = await fetch('/api/teacher/grades/export/pdf', {
                    headers: AuthManager.getAuthHeaders()
                });
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `성적표_${new Date().toISOString().split('T')[0]}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('PDF 내보내기에 실패했습니다: ' + error.message);
            }
        }

        function openStudentDetail(studentId) {
            location.href = `/teacher/student/${studentId}/detail`;
        }

        function startCounseling(studentId) {
            location.href = `/teacher/student/${studentId}/counseling`;
        }

        function logout() {
            AuthManager.logout();
        }

        loadGrades();
    </script>
</body>
</html>
