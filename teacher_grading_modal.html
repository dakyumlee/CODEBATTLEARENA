<div id="gradingModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 95vw;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(144, 205, 244, 0.3); padding-bottom: 15px;">
            <h3 class="modal-title">ë‹µì•ˆ ì±„ì </h3>
            <button class="btn btn-secondary" onclick="closeGradingModal()" style="width: 40px; height: 40px; border-radius: 50%; padding: 0;">Ã—</button>
        </div>
        
        <div class="grading-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: 70vh;">
            <div class="problem-section" style="background: rgba(26, 31, 54, 0.8); border-radius: 12px; padding: 20px; overflow-y: auto;">
                <h4 style="color: #90cdf4; margin-bottom: 15px;">ë¬¸ì œ ë‚´ìš©</h4>
                <div id="gradingProblemContent"></div>
            </div>
            
            <div class="submission-section" style="background: rgba(26, 31, 54, 0.8); border-radius: 12px; padding: 20px; overflow-y: auto;">
                <h4 style="color: #90cdf4; margin-bottom: 15px;">í•™ìƒ ë‹µì•ˆ</h4>
                <div id="gradingSubmissionContent"></div>
                
                <div class="grading-form" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(144, 205, 244, 0.3);">
                    <form id="gradingForm">
                        <input type="hidden" id="gradingSubmissionId">
                        
                        <div class="form-group">
                            <label class="form-label">ì ìˆ˜ (0-100)</label>
                            <input type="number" id="gradingScore" class="form-control" min="0" max="100" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">í”¼ë“œë°±</label>
                            <textarea id="gradingFeedback" class="form-control" rows="4" placeholder="í•™ìƒì—ê²Œ ì „ë‹¬í•  í”¼ë“œë°±ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                        </div>
                        
                        <div class="modal-actions" style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeGradingModal()">ì·¨ì†Œ</button>
                            <button type="submit" class="btn btn-primary">ì±„ì  ì™„ë£Œ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.grading-container {
    height: 70vh;
}

.problem-section, .submission-section {
    overflow-y: auto;
}

.problem-details {
    color: #e2e8f0;
    line-height: 1.6;
}

.problem-meta {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.problem-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.submission-info {
    background: rgba(45, 53, 97, 0.6);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.submission-answer {
    background: rgba(45, 53, 97, 0.8);
    padding: 15px;
    border-radius: 8px;
    color: #e2e8f0;
    font-family: 'Consolas', 'Monaco', monospace;
    white-space: pre-wrap;
    line-height: 1.5;
}

.submission-file {
    margin-top: 15px;
    padding: 15px;
    background: rgba(45, 53, 97, 0.6);
    border-radius: 8px;
    border: 1px solid rgba(144, 205, 244, 0.3);
}

@media (max-width: 768px) {
    .grading-container {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .problem-section, .submission-section {
        max-height: 400px;
    }
}
</style>

<script>
let currentGradingSubmission = null;

async function openGradingModal(submissionId) {
    try {
        const response = await fetch(`/api/teacher/submissions/${submissionId}/details`, {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            }
        });

        if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/';
            return;
        }

        const data = await response.json();
        
        if (data.error) {
            alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + data.error);
            return;
        }

        currentGradingSubmission = data;
        displayGradingModal(data);

    } catch (error) {
        console.error('ì±„ì  ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì±„ì  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
}

function displayGradingModal(data) {
    document.getElementById('gradingSubmissionId').value = data.submission.id;
    document.getElementById('gradingScore').value = data.submission.score || '';
    document.getElementById('gradingFeedback').value = data.submission.feedback || '';
    
    // ë¬¸ì œ ë‚´ìš© í‘œì‹œ
    const problemContent = document.getElementById('gradingProblemContent');
    problemContent.innerHTML = `
        <div class="problem-details">
            <h5 style="color: #90cdf4; margin-bottom: 10px;">${data.problem.title}</h5>
            
            <div class="problem-meta">
                <span class="problem-badge badge-difficulty-${data.problem.difficulty}" style="background: rgba(72, 187, 120, 0.2); color: #68d391;">${data.problem.difficulty}</span>
                <span class="problem-badge" style="background: rgba(159, 122, 234, 0.2); color: #a78bfa;">${getTypeKorean(data.problem.type)}</span>
                <span class="problem-badge" style="background: rgba(66, 153, 225, 0.2); color: #4299e1;">${data.problem.points}ì </span>
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong style="color: #90cdf4;">ë¬¸ì œ ì„¤ëª…:</strong><br>
                <div style="margin-top: 8px; padding: 12px; background: rgba(45, 53, 97, 0.6); border-radius: 8px;">
                    ${data.problem.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}
                </div>
            </div>
            
            ${data.problem.type === 'QUIZ' ? `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #90cdf4;">ì„ íƒì§€:</strong><br>
                    <div style="margin-top: 8px; padding: 12px; background: rgba(45, 53, 97, 0.6); border-radius: 8px;">
                        A) ${data.problem.optionA || ''}<br>
                        B) ${data.problem.optionB || ''}<br>
                        C) ${data.problem.optionC || ''}<br>
                        D) ${data.problem.optionD || ''}<br><br>
                        <strong style="color: #48bb78;">ì •ë‹µ: ${data.problem.correctAnswer}</strong>
                    </div>
                </div>
            ` : ''}
            
            <div>
                <strong style="color: #90cdf4;">ì œí•œ ì‹œê°„:</strong> ${data.problem.timeLimit}ë¶„<br>
                <strong style="color: #90cdf4;">ì¶œì œì¼:</strong> ${new Date(data.problem.createdAt).toLocaleDateString()}
            </div>
        </div>
    `;
    
    // í•™ìƒ ë‹µì•ˆ í‘œì‹œ
    const submissionContent = document.getElementById('gradingSubmissionContent');
    submissionContent.innerHTML = `
        <div class="submission-info">
            <strong style="color: #90cdf4;">í•™ìƒ:</strong> ${data.student.name}<br>
            <strong style="color: #90cdf4;">ì œì¶œì¼:</strong> ${new Date(data.submission.submittedAt).toLocaleString()}<br>
            <strong style="color: #90cdf4;">ìƒíƒœ:</strong> ${getStatusKorean(data.submission.status)}
        </div>
        
        ${data.submission.answer ? `
            <div style="margin-bottom: 15px;">
                <strong style="color: #90cdf4;">í…ìŠ¤íŠ¸ ë‹µì•ˆ:</strong>
                <div class="submission-answer">${data.submission.answer}</div>
            </div>
        ` : ''}
        
        ${data.submission.fileUrl ? `
            <div class="submission-file">
                <strong style="color: #90cdf4;">ì²¨ë¶€ íŒŒì¼:</strong><br>
                <div style="margin-top: 8px;">
                    <a href="${data.submission.fileUrl}" target="_blank" class="btn btn-secondary" style="margin-right: 10px;">
                        ğŸ“ ${data.submission.fileName}
                    </a>
                    <button class="btn btn-primary" onclick="previewSubmissionFile('${data.submission.fileUrl}', '${data.submission.fileName}')">
                        ë¯¸ë¦¬ë³´ê¸°
                    </button>
                </div>
            </div>
        ` : ''}
    `;
    
    document.getElementById('gradingModal').style.display = 'flex';
}

function closeGradingModal() {
    document.getElementById('gradingModal').style.display = 'none';
    currentGradingSubmission = null;
}

function getTypeKorean(type) {
    switch(type) {
        case 'QUIZ': return 'í€´ì¦ˆ';
        case 'EXAM': return 'ì‹œí—˜';
        default: return 'ë¬¸ì œ';
    }
}

function getStatusKorean(status) {
    switch(status) {
        case 'SUBMITTED': return 'ì œì¶œë¨';
        case 'GRADED': return 'ì±„ì ì™„ë£Œ';
        default: return status;
    }
}

function previewSubmissionFile(fileUrl, fileName) {
    window.open(fileUrl, '_blank');
}

document.getElementById('gradingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submissionId = document.getElementById('gradingSubmissionId').value;
    const score = document.getElementById('gradingScore').value;
    const feedback = document.getElementById('gradingFeedback').value;
    
    if (!score || score < 0 || score > 100) {
        alert('ì˜¬ë°”ë¥¸ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (0-100).');
        return;
    }
    
    try {
        const response = await fetch('/api/teacher/grade-submission', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
                submissionId: submissionId,
                score: parseInt(score),
                feedback: feedback
            })
        });
        
        if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/';
            return;
        }
        
        const result = await response.json();
        
        if (result.success) {
            alert('ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeGradingModal();
            if (typeof loadSubmissions === 'function') {
                loadSubmissions();
            }
        } else {
            alert('ì±„ì  ì‹¤íŒ¨: ' + result.message);
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
});

document.getElementById('gradingModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGradingModal();
    }
});
</script>
